<div class="container">
  <h1>ClientApp Dashboard</h1>
  <p class="lead">Rails 8 JSON-RPC Demo - Data Sender</p>

  <div class="row">
    <div class="col-md-2">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Users</h5>
          <h2 class="text-primary"><%= @total_users %></h2>
        </div>
      </div>
    </div>

    <div class="col-md-2">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Orders</h5>
          <h2 class="text-primary"><%= @total_orders %></h2>
        </div>
      </div>
    </div>

    <div class="col-md-2">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Pending</h5>
          <h2 class="text-warning"><%= @pending_records %></h2>
        </div>
      </div>
    </div>

    <div class="col-md-2">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Sent</h5>
          <h2 class="text-success"><%= @sent_records %></h2>
        </div>
      </div>
    </div>

    <div class="col-md-2">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Failed</h5>
          <h2 class="text-danger"><%= @failed_records %></h2>
        </div>
      </div>
    </div>

    <div class="col-md-2">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Target</h5>
          <h6 class="text-info">server:8999</h6>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>Create New Data</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h6>Create User</h6>
            <%= form_with url: data_create_user_path, method: :post, local: true do |f| %>
              <div class="input-group mb-2">
                <input type="text" name="name" class="form-control" placeholder="User name" required>
                <input type="email" name="email" class="form-control" placeholder="Email" required>
                <button type="submit" class="btn btn-primary">Create User</button>
              </div>
            <% end %>
          </div>

          <hr>

          <div class="mb-3">
            <h6>Create Order</h6>
            <%= form_with url: data_create_order_path, method: :post, local: true do |f| %>
              <div class="row g-2 mb-2">
                <div class="col-md-3">
                  <select name="user_id" class="form-select" required>
                    <option value="">User</option>
                    <% User.all.each do |user| %>
                      <option value="<%= user.id %>"><%= user.name %></option>
                    <% end %>
                  </select>
                </div>
                <div class="col-md-3">
                  <input type="text" name="product_name" class="form-control" placeholder="Product" required>
                </div>
                <div class="col-md-2">
                  <input type="number" name="quantity" class="form-control" placeholder="Qty" min="1" value="1" required>
                </div>
                <div class="col-md-2">
                  <input type="number" name="price" class="form-control" placeholder="Price" step="0.01" required>
                </div>
                <div class="col-md-2">
                  <button type="submit" class="btn btn-primary w-100">Create</button>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Recent Users</h5>
          <%= link_to "View All", users_path, class: "btn btn-sm btn-outline-primary" %>
        </div>
        <div class="card-body">
          <% if @recent_users.any? %>
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                </tr>
              </thead>
              <tbody>
                <% @recent_users.each do |user| %>
                  <tr>
                    <td><%= user.id %></td>
                    <td><%= user.name %></td>
                    <td><%= user.email %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p class="text-muted">No users created yet</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Recent Orders</h5>
          <%= link_to "View All", orders_path, class: "btn btn-sm btn-outline-primary" %>
        </div>
        <div class="card-body">
          <% if @recent_orders.any? %>
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>User</th>
                  <th>Product</th>
                  <th>Qty</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <% @recent_orders.each do |order| %>
                  <tr>
                    <td><%= order.id %></td>
                    <td><%= order.user&.name || 'N/A' %></td>
                    <td><%= order.product_name %></td>
                    <td><%= order.quantity %></td>
                    <td>$<%= number_with_precision(order.total_dollars, precision: 2) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p class="text-muted">No orders created yet</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Outgoing Records</h5>
          <%= link_to "View All", outgoing_records_path, class: "btn btn-sm btn-outline-primary" %>
        </div>
        <div class="card-body">
          <% if @recent_outgoing.any? %>
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Source ID</th>
                  <th>Status</th>
                  <th>Sent At</th>
                </tr>
              </thead>
              <tbody>
                <% @recent_outgoing.each do |record| %>
                  <tr>
                    <td><%= record.record_type %></td>
                    <td><%= record.data['id'] || record.id %></td>
                    <td>
                      <span class="badge bg-<%= record.status == 'sent' ? 'success' : (record.status == 'failed' ? 'danger' : 'warning') %>">
                        <%= record.status %>
                      </span>
                    </td>
                    <td><%= record.sent_at ? time_ago_in_words(record.sent_at) + ' ago' : '-' %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p class="text-muted">No outgoing records yet</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5>ActiveDataFlow Status</h5>
        </div>
        <div class="card-body">
          <p><strong>Engine:</strong> Mounted at /active_data_flow</p>
          <p><strong>JSON-RPC Target:</strong> http://server_app:8999</p>
          <p><strong>Storage Backend:</strong> ActiveRecord (SQLite)</p>
          <p><strong>Auto-load DataFlows:</strong> Enabled</p>

          <div class="mt-3">
            <%= link_to "ActiveDataFlow Management", "/active_data_flow", class: "btn btn-outline-primary" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
